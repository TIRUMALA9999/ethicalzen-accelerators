<div class="page-header">
  <h1>Executive Dashboard</h1>
  <p>Real-time AI safety governance overview across all frameworks</p>
</div>

<!-- KPI Row -->
<div class="kpi-grid" id="kpi-grid">
  <div class="kpi-card">
    <div class="kpi-label">Overall Risk Score</div>
    <div class="kpi-value" id="kpi-risk" style="color:var(--risk-low)">--</div>
    <div class="kpi-trend" id="kpi-risk-zone">Loading...</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Violations (24h)</div>
    <div class="kpi-value" id="kpi-violations">--</div>
    <div class="kpi-trend" id="kpi-block-rate">--</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Compliance Coverage</div>
    <div class="kpi-value" id="kpi-coverage">--</div>
    <div class="kpi-trend">Across 3 frameworks</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Drift Alerts</div>
    <div class="kpi-value" id="kpi-drift">--</div>
    <div class="kpi-trend" id="kpi-drift-status">--</div>
  </div>
</div>

<!-- Charts Row -->
<div class="grid-2" style="margin-bottom:24px">
  <div class="card">
    <div class="card-header">
      <span class="card-title" id="timeline-title">Violation Timeline (24h)</span>
    </div>
    <canvas id="chart-timeline" style="width:100%;height:200px"></canvas>
  </div>
  <div class="card">
    <div class="card-header">
      <span class="card-title">Risk Gauge</span>
    </div>
    <canvas id="chart-gauge" style="width:100%;height:200px"></canvas>
  </div>
</div>

<!-- Recent Violations + Quick Actions -->
<div class="grid-2">
  <div class="card">
    <div class="card-header">
      <span class="card-title">Recent Violations</span>
      <a href="#violations" class="btn btn-sm btn-secondary">View All</a>
    </div>
    <table class="data-table">
      <thead>
        <tr><th>Time</th><th>Type</th><th>Status</th><th>Score</th></tr>
      </thead>
      <tbody id="recent-violations">
        <tr><td colspan="4" class="empty-state" style="padding:30px">Loading...</td></tr>
      </tbody>
    </table>
  </div>
  <div class="card">
    <div class="card-header">
      <span class="card-title">Quick Actions</span>
    </div>
    <div style="display:flex;flex-direction:column;gap:12px;padding:8px 0">
      <a href="#exports" class="btn btn-primary" style="justify-content:center">Generate OSCAL Report</a>
      <a href="#exports" class="btn btn-secondary" style="justify-content:center">Export STIX Bundle</a>
      <a href="#evidence" class="btn btn-secondary" style="justify-content:center">View Audit Trail</a>
      <a href="#compliance" class="btn btn-secondary" style="justify-content:center">Compliance Matrix</a>
      <a href="#drift" class="btn btn-secondary" style="justify-content:center">Check Drift Status</a>
    </div>
  </div>
</div>

<script>
async function init_dashboard() {
  // Fire both calls in parallel — each renders independently on settle
  const [riskResult, vResult] = await Promise.allSettled([
    API.risk(),
    API.violations({ limit: 200 })
  ]);

  // --- Risk KPI section ---
  if (riskResult.status === 'fulfilled') {
    const risk = riskResult.value;
    document.getElementById('kpi-risk').textContent = risk.overall;
    document.getElementById('kpi-risk').style.color = Utils.riskColor(risk.overall);
    document.getElementById('kpi-risk-zone').textContent = `${(risk.zone || '').toUpperCase()} risk zone`;
    document.getElementById('kpi-violations').textContent = risk.violations24h || 0;
    document.getElementById('kpi-block-rate').textContent = `${risk.blockRate || 0}% block rate`;
    document.getElementById('kpi-drift').textContent = risk.activeDriftAlerts || 0;
    document.getElementById('kpi-drift-status').textContent = risk.activeDriftAlerts > 0 ? 'Action needed' : 'All clear';
    Charts.gauge('chart-gauge', risk.overall);
  } else {
    document.getElementById('kpi-risk').textContent = '--';
    document.getElementById('kpi-risk-zone').textContent = 'Unable to load risk data';
    document.getElementById('kpi-violations').textContent = '--';
    document.getElementById('kpi-block-rate').textContent = '--';
    document.getElementById('kpi-drift').textContent = '--';
    document.getElementById('kpi-drift-status').textContent = '--';
    console.error('Risk load error:', riskResult.reason);
  }

  // --- Compliance Coverage KPI ---
  // Calculate coverage across all 3 frameworks (same logic as compliance page)
  const frameworkControls = {
    nist_ai_rmf: 12,
    iso_42001: 10,
    nist_csf: 9
  };
  const totalControls = Object.values(frameworkControls).reduce((a, b) => a + b, 0); // 31
  // Deterministic: ~58% satisfied per framework (matches compliance page formula: 0.97 - i*0.035 >= 0.75)
  let totalCovered = 0;
  Object.values(frameworkControls).forEach(count => {
    for (let i = 0; i < count; i++) {
      if ((0.97 - i * 0.035) >= 0.75) totalCovered++;
    }
  });
  const coveragePct = Math.round((totalCovered / totalControls) * 100);
  document.getElementById('kpi-coverage').textContent = coveragePct + '%';

  // --- Violations section ---
  const tbody = document.getElementById('recent-violations');
  if (vResult.status === 'fulfilled') {
    const vData = vResult.value;
    const violations = Array.isArray(vData) ? vData : (vData.violations || vData.data || []);
    if (violations.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="empty-state" style="padding:30px">No violations in the last 24 hours</td></tr>';
    } else {
      tbody.innerHTML = violations.slice(0, 10).map(v => `
        <tr>
          <td class="mono">${Utils.timeAgo(v.timestamp)}</td>
          <td>${Utils.truncate(v.violation_type || v.guardrail_id || '-', 25)}</td>
          <td>${Utils.statusBadge(v.status)}</td>
          <td>${Utils.scoreBar(v.risk_score || 0)}</td>
        </tr>
      `).join('');
    }

    // Timeline chart — smart: use hourly buckets for last 24h, daily for 7d
    const now = new Date();
    const oldest = violations.length > 0 ? new Date(violations[violations.length - 1].timestamp) : now;
    const spanHours = (now - oldest) / 3600000;

    // Build severity-segmented buckets
    const buckets = [];

    if (spanHours <= 48) {
      // Hourly buckets for last 24h (show 8 × 3-hour slots)
      document.getElementById('timeline-title').textContent = 'Violation Timeline (24h)';
      for (let i = 7; i >= 0; i--) {
        const slotEnd = new Date(now - i * 3 * 3600000);
        const slotStart = new Date(slotEnd - 3 * 3600000);
        const slotViolations = violations.filter(v => {
          const t = new Date(v.timestamp).getTime();
          return t >= slotStart.getTime() && t < slotEnd.getTime();
        });
        const segments = { critical: 0, high: 0, moderate: 0, low: 0 };
        slotViolations.forEach(v => {
          const sev = (v.severity || 'moderate').toLowerCase();
          segments[sev] = (segments[sev] || 0) + 1;
        });
        const label = slotEnd.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        buckets.push({ label, segments });
      }
    } else {
      // Daily buckets for 7 days
      document.getElementById('timeline-title').textContent = 'Violation Timeline (7 days)';
      for (let i = 6; i >= 0; i--) {
        const d = new Date(now - i * 86400000);
        const dayViolations = violations.filter(v => {
          return new Date(v.timestamp).toDateString() === d.toDateString();
        });
        const segments = { critical: 0, high: 0, moderate: 0, low: 0 };
        dayViolations.forEach(v => {
          const sev = (v.severity || 'moderate').toLowerCase();
          segments[sev] = (segments[sev] || 0) + 1;
        });
        buckets.push({ label: Utils.formatDateShort(d.toISOString()), segments });
      }
    }

    Charts.stackedBarChart('chart-timeline', buckets);
  } else {
    tbody.innerHTML = '<tr><td colspan="4" class="empty-state" style="padding:30px">Unable to load violations</td></tr>';
    console.error('Violations load error:', vResult.reason);
  }
}
</script>
